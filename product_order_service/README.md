# Сервис заказа продуктов #

Для работы приложения необходимо установить redis-server (sudo apt-get install redis-server) и запустить командой:
redis-server. Для запуска redis в ОС windows необходима версия windows 7 и выше. Инструкция по запуску redis в windows:
https://skillbox.ru/media/base/kak_ustanovit_redis_v_os_windows_bez_ispolzovaniya_docker/
Запуск celery: celery -A product_order_service worker -l INFO
Также проведена автогенерация документации с помощью библиотеки drf-yasg в ОС Windows 7. Просмотреть можно перейдя по
ссылке: http://127.0.0.1:8000/swagger/

### Регистрация, авторизация и выход пользователя ###
Для регистрации пользователя необходимо перейти по адресу: http://127.0.0.1:8000/api/v1/registration/ используя,
например, Postman или расширение для google chrome -  Talend API Tester. В теле запроса нужно отправить имя, адрес
электронной почты и пароль создаваемого пользователя. Если Вы являетесь поставщиком, то нужно добавить is_staff: True,
например:
```
{"username": "your_username",
 "email": "your_email",
 "password": "your_password",
 "is_staff": true}
```
Выше регистрация для поставщика, ниже для покупателя:
```
{"username": "your_username",
 "email": "your_email",
 "password": "your_password"}
```
Пользователь будет зарегистрирован, а на почту, указанную при регистрации придет подтверждение об успешной регистрации. 
Для авторизации необходимо перейти по адресу: http://127.0.0.1:8000/api/v1/auth/token/login/, используя данные введенные
при регистрации кроме почты и статуса персонала. В ответ придет Token назначенный пользователю. Данный токен необходимо
указывать в запросах для действий, которые разрешены только авторизованным пользователям. Например Ваш токен 123456,
тогда при выполнении запроса в HEADERS необходимо указать:
```
{"Authorization": "Token 123456"}
```
Для того, чтоб разлогинить пользователя, необходимо по адресу http://127.0.0.1:8000/api/v1/auth/token/logout/ в HEADERS
указать токен, как в предыдущем примере, а тело запроса оставить пустым. Метод POST. Пользователь будет разлогинен.

### Авторизация через соцсети VK и mail.ru ###
Для авторизации через соцсеть VK необходимо зарегистрировать приложение в VK, получить id приложения и защищённый ключ.
Open API должно быть включено. При создании выбрать "сайт" (а не standalone и др) и указать адрес сайта, в нашем случае
локальный адрес. В mail.ru при создании приложения нужно указать redirect_uri. Для авторизации в данном приложении был
указан uri локальной машины. Настройка авторизации через mail.ru, создание приложений в django admin, а также добавление
параметров в settings.py производилась по данной инструкции:
https://pythonrepo.com/repo/PhilipGarnero-django-rest-framework-social-oauth2-python-implementing-authentications-schemes
Access_token для получения токена для авторизации с помощью VK получен по данной ссылке, где вместо YOUR_VK_ID нужно
подставить ID вашего приложения VK. Ссылка:
https://login.vk.com/?act=openapi&oauth=1&aid=YOUR_VK_ID&location=127.0.0.1&new=1&response_type=code
Данный токен нужно вставить в тело запроса. Пример запроса для получения Bearer token в VK (при запросе получена ошибка,
о том что версия устарела): https://prnt.sc/1ucll64
И пример получения Bearer token через mail.ru, где токен успешно получен: https://prnt.sc/1uclz89
Данные токены нужно указывать в запросах в приложении, как для авторизованного пользователя, но вместо Token нужно 
указать Bearer перед токеном:
```
{"Authorization": "Bearer 123456"}
```

### Продукты ###
Для просмотра списка продуктов перейдите по адресу: http://127.0.0.1:8000/api/v1/products/. Список товаров и информацию
о конкретоном товаре просматривать могут все. Если вы поставщик (поставщик при регистрации должен к имени пользователя,
паролю и почте добавить "is_staff": true, по умолчанию ставится false), то можете добавлять продукты в список. Поставщик
может изменять информацию о своих товарах. При показе списка товаров в описании показаны статусы поставщика: принимает
он заказы или нет (is_active, если true, то принимает). При регистрации ставится true по умолчанию. Для более подробной 
информации о товаре к адресу добавьте id товара, например: /api/v1/products/1/. Для создания продуктов нужно
имортировать данные из файла yaml формата. В корне проекта приложен пример файла (shop1.yaml). Для импорта необходимо 
сделать post запрос. В HEADERS указать токен поставщика, Content-Type: multipart/form-data, Content-Disposition:
attachment; filename="filename.yaml". Затем в теле запроса нужно выбрать вкладку "form", в первом поле написать file, во
втором выбрать вкладку File и выбрать файл для отправки. Пример: https://prnt.sc/1td8um1. В приложении введено
ограничение на количество просмотров списка продуктов для неавторизованных пользователей и ограничение загрузок файла
для авторизованных пользователей - 20 в день. Эти параметры можно изменить в settings.py - параметр uploads для загрузок
файла и anon для ограничения просмотра списка продуктов:
```
    'DEFAULT_THROTTLE_RATES': {
        'anon': '60/minute',
        'orders.create': '5/day',
        'orders.update': '5/day',
        'uploads': '20/day'
    }
```

### Заказы ### 
Для создания заказа перейдите по адресу: http://127.0.0.1:8000/api/v1/orders/. Если пользователь является поставщиком,
то отобразится список заказов, сделанных у него покупателями. Для авторизованного пользователя отобразятся только свои
заказы. Поставщик тоже имеет возможность сделать заказ. Для того, чтобы сделать заказ пользователь должен быть
авторизован. Для создания заказа, введите в списке "products_list" id продукта, id поставщика и количество (quantity).
Статус автоматически ставится на "NEW". При создании заказа отправляются письма с подтверждением на
адрес покупателя и адрес поставщика с уведомлением о новом заказе. При отмене заказа поставщику приходит письмо об
отмене. При смене статуса поставщиком, покупателю приходит письмо о смене статуса заказа. Ниже приведён пример заказа
двух товаров от одного или разных поставщиков: 
```
{"products_list": [{
               "product": product_id,
               "provider": provider_id,
               "quantity": quantity(int)
              },
              {
               "product": product_id,
               "provider": provider_id,
               "quantity": quantity(int)
              }]
}
```
Покупатель может только отменить заказ. Для этого нужно перейти на страницу заказа, добавив к адресу id заказа,
например: http://127.0.0.1:8000/api/v1/orders/1/ и отправить PATCH запрос и указать статус "CANCELLED". Поставщик может
ставить любой статус. Пример запроса для смены статуса заказа:
```
{"status": "choose_status"}
```
Пример одинаков для покупателя и поставщика. Список статусов:
```
    "NEW" - "Новый"
    "IN_PROGRESS" - "Выполняется"
    "DONE" - "Готов"
    "CANCELLED" - "Отменён"
``` 
Покупатель, на странице заказа может внести изменения в заказ выбрав UPDATE запрос. Форма для отправки как при создании
заказа. Поставщик может удалять выполненные или отменённые заказы. Для этого на странице заказа нужно сделать delete
запрос. В приложении введено ограничение на количество заказов для пользователя - 5 в день, а также на количество 
внесений изменений в заказах. Этот параметр можно изменить в settings.py, параметр orders.create - ограничение на
создание заказов, параметр orders.update - на обновление заказов:
```
    'DEFAULT_THROTTLE_RATES': {
        'anon': '60/minute',
        'orders.create': '5/day',
        'orders.update': '5/day',
        'uploads': '20/day'
    }
```

### Отсчет по тестам ###
Команда для запуска тестов: pytest --cov=order_app tests/
Отсчёт по ссылке: https://prnt.sc/1ucjudk
